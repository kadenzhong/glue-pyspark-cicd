name: Glue PySpark CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: è®¾ç½® PYTHONPATH  # âœ… æ·»åŠ è¿™ä¸€æ­¥ï¼Œç¡®ä¿ pytest èƒ½æ‰¾åˆ° scripts ç›®å½•
        run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/scripts" >> $GITHUB_ENV

      - name: è¿è¡Œ pytest å•å…ƒæµ‹è¯•
        run: pytest tests/test_utils.py

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: å®‰è£… AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli
          
      - name: é…ç½® AWS è®¿é—®å‡­è¯
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2  # ğŸš€ ä½ åœ¨æ‚‰å°¼ï¼Œåº”è¯¥ä½¿ç”¨è¿™ä¸ªåŒºåŸŸ

      - name: æ£€æŸ¥ AWS CLI æ˜¯å¦æ­£å¸¸
        run: aws s3 ls

      - name: ä¸Šä¼  Glue Job è„šæœ¬ï¼ˆè¦†ç›–æ—§çš„ï¼‰
        run: |
          aws s3 cp scripts/job.py s3://group-script1/script/job.py

      - name: æ‰“åŒ…å¹¶ä¸Šä¼ æœ€æ–°çš„ utils.zip
        run: |
          zip -r utils.zip scripts/utils.py
          aws s3 cp utils.zip s3://group-script1/script/utils.zip
          
      - name: æ£€æŸ¥ GitHub Actions è¿è¡Œçš„ AWS èº«ä»½  # âœ… è¿™é‡Œæ£€æŸ¥ AWS èº«ä»½
        run: aws sts get-caller-identity

      - name: æ›´æ–° Glue Job ä¾èµ–ï¼Œç¡®ä¿åŠ è½½æœ€æ–°çš„ utils.zip
        run: |
          aws glue update-job --job-name "GlueCICDJob" --job-update '{
            "Role": "arn:aws:iam::123456789012:role/AWSGlueServiceRole",
            "Command": {
              "Name": "glueetl",
              "ScriptLocation": "s3://group-script1/script/job.py"
            },
            "DefaultArguments": {
              "--extra-py-files": "s3://group-script1/script/utils.zip"
            }
          }'

